<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('审核商品信息')" />
    <th:block th:include="include :: summernote-css"/>
    <style type="text/css">
        .form-control[disabled], .form-control[readonly], fieldset[disabled] .form-control {
            background-color: #FFF;
            opacity: 1;
        }
       .single-line {
            background: #FFFFFF none;
            border: 1px solid #e5e6e7;
            border-radius: 1px;
            color: inherit;
            display: block;
            padding: 6px 12px;
            -webkit-transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
            transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
            width: 100%;
            font-size: 14px;
        }
        .summernoteBox{
            overflow-y: auto;
            overflow-x: hidden;
        }
        .summernoteBox img {
            width: 100% !important;
        }
    </style>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" th:object="${pmsProduct}">
        <input name="id" th:field="*{id}" type="hidden">
        <h4 class="form-header h4">基本信息<span class="help-block m-b-none"><i class="fa fa-thumb-tack"></i> 商品货号：<span th:text="*{productSn}"></span></span></h4>
        <div class="row" id="leftContent">
            <div class="col-sm-6">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">店铺名称：</label>
                            <div class="col-sm-8">
                                <input name="shopName" class="form-control" type="text" th:field="*{shopName}" autocomplete="off" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">商品名称：</label>
                            <div class="col-sm-8">
                                <input name="name" th:field="*{name}" class="form-control"  readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">副标题：</label>
                            <div class="col-sm-8">
                                <input name="subTitle" th:title="*{subTitle}" class="form-control" type="text" th:field="*{subTitle}" autocomplete="off" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">商品描述：</label>
                            <div class="col-sm-8">
                                <input name="description" th:title="*{description}" th:field="*{description}" class="form-control" readonly >
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">

                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">商品分类：</label>
                            <div class="col-sm-8">
                                <input name="productCategoryName" class="form-control" type="text" th:field="*{productCategoryName}" autocomplete="off" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">商品品牌：</label>
                            <div class="col-sm-8">
                                <input name="brandName" th:field="*{brandName}" class="form-control" readonly >
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row">

                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">商品价格：</label>
                            <div class="col-sm-8">
                                <input name="price" class="form-control" type="text" th:field="*{price}" autocomplete="off" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">市场价格：</label>
                            <div class="col-sm-8">
                                <input name="originalPrice" th:field="*{originalPrice}" class="form-control"  readonly>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-3 control-label is-required">支付方式：</label>
                            <div class="col-sm-8">
                                <input id="paymentType" name="paymentType" class="form-control" type="hidden" th:field="*{paymentType}">
                                <div  style="width: 80%;">
                                    <input type="radio" name="paymentType0" value="1" id="paymentType1" checked><label>线上付款</label>
                                    <input type="radio" name="paymentType0" value="2" id="paymentType2" style="margin-left: 2%;"  ><label>货到付款</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">

                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">商品销售参数：</label>
                            <div class="col-sm-8">
                                <div class="form-control-static single-line" id="paramDataShow"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">关键字：</label>
                            <div class="col-sm-8">
                                <input name="keywords" th:field="*{keywords}" class="form-control" readonly >
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row">

                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">详情页标题：</label>
                            <div class="col-sm-8">
                                <input name="detailTitle" th:title="*{detailTitle}" class="form-control" type="text" th:field="*{detailTitle}" autocomplete="off" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">详情页描述：</label>
                            <div class="col-sm-8">
                                <input name="detailDesc" th:title="*{detailDesc}" th:field="*{detailDesc}" class="form-control" readonly >
                            </div>
                        </div>
                    </div>

                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">商品详情视频：</label>
                    <div class="col-sm-6">
                        <input name="detailVideo" class="form-control" type="hidden" th:field="*{detailVideo}">
                        <ul class="ft-uploader__files" id="detailVideoShow" style="margin-top: 10px;">
                            <!-- 图片展示 -->
                        </ul>
                        <div class="ft-uploader__input-box" id="detailVideoBox">
                            <button id="detailVideoBtn" type="button" class="ft-uploader__input"></button>
                        </div>
                        <span class="help-block m-b-none" style="clear: both;"><i class="fa fa-info-circle"></i> 商品详情中视频 </span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">审核状态：</label>
                            <div class="col-sm-8">
                                <input name="verifyStatus" class="form-control" th:value="${@custom.auditTypes().get('__${pmsProduct.verifyStatus}__')}" type="text" autocomplete="off" readonly >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <input  name="detailHtml" class="form-control" type="hidden" th:field="*{detailHtml}" autocomplete="off" readonly>
                            <div class="col-sm-8 col-sm-offset-1" id="rightContent" >
                                <div class="ibox summernoteBox">
                                    <div class="ibox-content" >
                                        <div class="click2edit wrapper" >
                                            <!--详情页面-->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>

        </div>
        <h4 class="form-header h4">sku信息</h4>
        <div class="table">
            <input type="hidden" name="skuList" th:field="*{skuList}" id="skuList">
            <table id="skuTable">
                <!--sku列表-->
            </table>
        </div>
        <h4 class="form-header h4">图片资料</h4>

        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">商品主图：</label>
                    <div class="col-sm-10">
                        <input name="pic" th:field="*{pic}" class="form-control" type="hidden">
                        <ul class="ft-uploader__files" id="picImg" style="margin-top: 10px;" >
                            <!-- 图片展示 -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">商品视频：</label>
                    <div class="col-sm-10">
                        <input name="video" th:field="*{video}" class="form-control" type="hidden">
                        <ul class="ft-uploader__files" id="videoUL" style="margin-top: 10px;" >
                            <!-- 图片展示 -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">商品画册：</label>
                    <div class="col-sm-10">
                        <input name="albumPics" th:field="*{albumPics}" class="form-control" type="hidden">
                        <ul class="ft-uploader__files" id="albumPicsImg" style="margin-top: 10px;" >
                            <!-- 图片展示 -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <form class="form-horizontal m" id="form-pmsProduct-audit" th:object="${pmsProduct}">
        <h4 class="form-header h4">审核情况</h4>
        <input name="id" th:field="*{id}" type="hidden">
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">审核意见：</label>
                    <div class="col-sm-10">
                        <textarea name="auditMsg" th:field="*{auditMsg}" th:readonly="!${pmsProduct.verifyStatus=='01'}" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group" th:if="${pmsProduct.verifyStatus=='01'}">
            <div class="col-sm-8 col-sm-offset-2" >
                <button type="button" id="submitBtn" class="btn btn-primary">审核通过</button>
                <button type="button" id="refuseBtn" class="btn btn-warning">审核拒绝</button>
            </div>
        </div>
    </form>

</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: layui-all-js"/>
<th:block th:include="include :: summernote-js"/>
<script th:inline="javascript" type="text/javascript">
    var prefix = ctx + "business/pmsProduct";
    var skuList = [[${pmsProduct.skuList}]]
    //销售参数处理
    var paramData = [[${pmsProduct.paramData}]]
    var productName = [[${pmsProduct.name}]]
    var paramJson = jQuery.parseJSON(paramData);
    var params = "";

    //skuList处理
    var rows=[];
    skuList.forEach(function (value, index, array) {
        value.productName = productName;
        rows[index]=value;
    });
    var options = {
        data: rows,
        showSearch: false,
        striped: true,
        showRefresh: false,
        showColumns: false,
        showToggle: false,
        columns: [

            {
                field : 'productName',
                title : '商品名称',
                align: 'center',
            },
            {
                field : 'spData',
                title : '规格',
                align: 'center',
                formatter: function(value, row, index) {
                    var obj = jQuery.parseJSON(value);
                    return  $.table.tooltip(Object.values(obj),10,'open')
                }
            },
            {
                field : 'pic',
                title : '展示图片',
                align: 'center',
                formatter : function(value, row, index) {
                    return $.table.imageView(respath+value);
                }
            },
            {
                field : 'skuCode',
                title : 'sku编码',
                align: 'center',
            },
            {
                field : 'price',
                title : '价格(元)',
                align: 'center',
            },
            {
                field : 'stock',
                title : '剩余库存',
                align: 'center',
                formatter: function(value, row, index) {
                    return  value-row.lockStock;
                }
            },
            {
                field : 'lowStock',
                title : '预警库存',
                align: 'center',
            },
            {
                field : 'sale',
                title : '销量',
                align: 'center',
            },
        ],
        onLoadSuccess: function () {
        },
        onLoadError: function () {
            $.modal.alert("数据加载失败！");
        },
    };

    $('#skuTable').bootstrapTable(options);

    //重新绑定点击图片预览事件
    $('#skuTable').off("click").on("click", '.img-circle', function () {
        var src = $(this).attr('src');
        var target = $(this).data('target');
        var height = $(this).data('height');
        var width = $(this).data('width');
        var maxWidth = ($(window).width() * 0.7) + 'px';
        var maxHeight = ($(window).height() * 0.9) + 'px';
        if ($.common.equals("self", target)) {
            layer.open({
                title: false,
                type: 1,
                closeBtn: true,
                shadeClose: true,
                area: ['auto', 'auto'],
                content: "<img src='" + src + "' height='" + height + "' width='" + width + "'  style='max-width: " + maxWidth + "; max-height: " + maxHeight + "; '/>"
            });
        } else if ($.common.equals("blank", target)) {
            window.open(src);
        }
    });

    $(function () {

        for (var paramJsonKey in paramJson) {
            params += paramJsonKey +":"+paramJson[paramJsonKey]+"<br/>";
        }
        $("#paramDataShow").html(params);

        $("#rightContent").height($("#leftContent").height()-15);

        $('.click2edit').append( $("input[name='detailHtml']").val());
        //富文本展示init
        $('.click2edit').summernote({
            lang: 'zh-CN',
            focus: true,
            height: 600
        });
        $('.click2edit').summernote('destroy');
        // 展示图片信息
        var albumPics = $("input[name='albumPics']").val();
        var pic = $("input[name='pic']").val();
        var video = $("input[name='video']").val();
        var detailVideo = $("input[name='detailVideo']").val();

        initAlbumPics(albumPics);
        initPic(pic);
        initVideo(video);
        initDetailVideo(detailVideo);

        var paymentType = $("input[name='paymentType']").val();
        console.log("paymentType="+paymentType)
        if(paymentType=='1'){
            //设置选中
            $("input:radio[value='1']").attr('checked','true');
            //隐藏定金
            $("#deposit0").hide();
        }else if(paymentType=='2'){
            //设置选中
            $("input:radio[value='2']").attr('checked','true');
            //显示定金
            $("#deposit0").show();
        }

        $("#submitBtn").on("click", auditPass);
        $("#refuseBtn").on("click", auditRefuse);
    });

    /**
     * 初始化商品主图
     */
    function initPic(pic) {
        if (pic) {
            var tpl = "<li class=\"ft-uploader__file\" style=\"background-image:url(" + respath + pic + ")\" data-src=\"" + pic + "\" ></li>";
            $("#picImg").append(tpl);
        }
    }
    /**
     * 初始化商品画册
     */
    function initAlbumPics(albumPics) {
        if (albumPics && albumPics.split(",").length > 0) {
            var pics = albumPics.split(","), tpl = "";
            for (var i in pics) {
                tpl += "<li class=\"ft-uploader__file\" style=\"background-image:url(" + respath + pics[i] + ")\" data-src=\"" + pics[i] + "\" ></li>";
            }
            $("#albumPicsImg").html(tpl);
        }
    }

    /**
     * 初始化商品视频
     */
    function initVideo(video) {

        if (video) {
            var tpl = "<li style=\"max-width:300px;position: relative;\" data-src=\"" + video + "\" ><video class=\"video\" src=\""+ respath + video +"\" controls=\"controls\" autoplay=\"autoplay\">您的浏览器不支持 video 标签。</video></li>";
            $("#videoUL").append(tpl);
        }
    }

    function initDetailVideo(video) {
        console.log("video="+video)
        if (video) {
            var tpl = "<li style=\"max-width:300px;position: relative;\" data-src=\"" + video + "\" ><video class=\"detailVideo\" src=\""+ respath + video +"\" controls=\"controls\" autoplay=\"autoplay\">您的浏览器不支持 video 标签。</video><img class=\"posImgDel del-img\" src=\"../../../img/close.png\" /></li>";
            $("#detailVideoShow").append(tpl);
        }
    }


    /**
     * 审核通过
     */
    function auditPass() {
        $.modal.confirm("确认审核通过？", function () {
            $.operate.save(prefix + "/pass", $('#form-pmsProduct-audit').serialize());
        });
    }

    /**
     * 审核拒绝
     */
    function auditRefuse() {
        if ($.validate.form("form-pmsProduct-audit")) {
            $.modal.confirm("确认审核拒绝？", function() {
                $.operate.save(prefix + "/refuse", $('#form-pmsProduct-audit').serialize());
            });
        }
    }

    // 表单验证
    $("#form-pmsProduct-audit").validate({
        focusCleanup: true,
        ignore: [],
        rules: {
            auditMsg: {
                required: true,
                rangelength: [2, 50],
            }
        },
        messages: {
            auditMsg: {
                rangelength: $.validator.format("审核意见长度在 {0} 到 {1} 之间"),
                required: "请填写审核意见"
            },
        }
    });

    /**
     * 图片预览--通用
     */
    $(".ft-uploader__files").on("click", ".ft-uploader__file", function(e) {
        if ($(this).attr("data-src")) {
            $.modal.preview(respath + $(this).attr("data-src"));
        }
    });


</script>
</body>
</html>